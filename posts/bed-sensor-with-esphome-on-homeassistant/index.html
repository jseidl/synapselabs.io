<!DOCTYPE html>
<html lang="en-us"><head>
  <meta charset="utf-8">
  <title>Making a bed occupancy sensor with bathroom scales, ESP32, HX711 load-cell sensors and ESPHome on Home Assistant</title>

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description"
    content="Learn how to build a bed occupancy sensor using bathroom scales, an ESP32, HX711 load-cell sensors and ESPHome on Home Assistant">
  
  <meta name="author" content="Jan Seidl">
  <meta name="generator" content="Hugo 0.65.3" />

  <!-- plugins -->
  
  <link rel="stylesheet" href="https://synapselabs.io/plugins/bootstrap/bootstrap.min.css ">
  
  <link rel="stylesheet" href="https://synapselabs.io/plugins/themify-icons/themify-icons.css ">
  

  <!-- Main Stylesheet -->
  
  <link rel="stylesheet" href="https://synapselabs.io/scss/style.min.css" media="screen">

  <!--Favicon-->
  <link rel="shortcut icon" href="https://synapselabs.io/images/favicon.png " type="image/x-icon">
  <link rel="icon" href="https://synapselabs.io/images/favicon.png " type="image/x-icon">

  </head><body>
<!-- preloader start -->
<div class="preloader">
  
</div>
<!-- preloader end -->
<!-- navigation -->
<header class="fixed-top navigation">
  <div class="container">
    
    <nav class="navbar navbar-expand-lg navbar-light bg-transparent">
      <a class="navbar-brand"href="https://synapselabs.io/"><img class="img-fluid" src="/images/logo.png" alt="synapse labs ðŸ§ "></a>
      <button class="navbar-toggler border-0" type="button" data-toggle="collapse" data-target="#navigation">
        <i class="ti-menu h3"></i>
      </button>

      <div class="collapse navbar-collapse text-center" id="navigation">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <a class="nav-link" href="https://synapselabs.io/"> Home </a>
          </li>
          
            
            <li class="nav-item">
              <a class="nav-link" href="https://synapselabs.io/about">About</a>
            </li>
            
          
            
            <li class="nav-item">
              <a class="nav-link" href="https://synapselabs.io/contact">Contact</a>
            </li>
            
          
        </ul>
        
        <!-- search -->
        <div class="search">
          <button id="searchOpen" class="search-btn"><i class="ti-search"></i></button>
          <div class="search-wrapper">
            <form action="https://synapselabs.io//search" class="h-100">
              <input class="search-box px-4" id="search-query" name="s" type="search" placeholder="Type & Hit Enter...">
            </form>
            <button id="searchClose" class="search-close"><i class="ti-close text-dark"></i></button>
          </div>
        </div>
        
      </div>
    </nav>
  </div>
</header>
<!-- /navigation --> <div class="py-5 d-none d-lg-block"></div> 

<section class="section">
  <div class="container">
    <div class="row">
      <div class="col-lg-12 mx-auto block shadow mb-5">
        <h2>Making a bed occupancy sensor with bathroom scales, ESP32, HX711 load-cell sensors and ESPHome on Home Assistant</h2>
        <div class="mb-3 post-meta">
          <a href="/author/jan-seidl">Jan Seidl</a>,
          April 6, 2020, in 
          <a href="/categories/home-automation">Home automation</a>
          
        </div>
        
        <img src="/images/featured-post/building-bed-sensor.jpg" class="img-fluid w-100 mb-4" alt="Making a bed occupancy sensor with bathroom scales, ESP32, HX711 load-cell sensors and ESPHome on Home Assistant">
        
        <div class="content">
          <p>After slapping around multiple <a href="/posts/multisensors-with-esphome-on-homeassistant/">ESPHome-based multisensors</a> around the house, I needed a way to keep them from going off while I&rsquo;m sleeping and I wasn&rsquo;t quite fond of manually disabling and re-enabling the automations in a daily basis. In order to get Home Assistant to know when myself or my wife are in bed, I&rsquo;ve decided to create custom bed occupancy sensors using a pair of bathroom scales, a pair of HX711 load-cell sensors on top of the same framework (ESPHome).</p>
<h3 id="what-youre-gonna-need">What you&rsquo;re gonna need</h3>
<ul>
<li><a href="https://amzn.to/32HSPmg">ESP32 micro-controller</a></li>
<li>Two <a href="https://amzn.to/2VMm2Lp">HX711 load-cell sensor</a></li>
<li>Some <a href="https://amzn.to/38be2G4">short dupont-cables</a></li>
<li><em>Optional: 4-conductor (RJ11) telephone cable + dual line RJ11 keystone box</em></li>
</ul>
<h3 id="wiring-it-up">Wiring it up</h3>
<p>Usually the boards on the bathroom scales have already labeled the <code>S+</code>, <code>S-</code>, <code>E+</code>, <code>E-</code> pads. Just solder those pads to the respective pads on the HX711 and in the other end, connect <code>V</code>, <code>GND</code>, <code>DOUT</code> and <code>CLK</code> to the ESP32. I&rsquo;ve used short cables to wire the bathroom scale side to the HX711 and house the IC inside the bathroom scale cover, drilled a hole to pass the cables through and used a 4-conductor telephone cable and a two-line keystone box to connect the HX711 to the ESP32 (the cable between the keystone box and the ESP32 is a regular ethernet cable because it has all 8 conductors needed).</p>
<p><img src="/images/posts/bed-sensor-with-esphome-on-homeassistant/bathroom-scale-wiring.jpg" alt="Bathroom scale wiring (sorry about my sexy thighs)">
<em>Bathroom scale board &amp; drilled enclosure.</em></p>
<p><img src="/images/posts/bed-sensor-with-esphome-on-homeassistant/bed-sensor-wiring.jpg" alt="Bed sensor wiring (sorry about my sexy thighs)">
<em>From left to right: Assembled, HX711 wiring, RJ11 keystone terminals on an ethernet cable, wiring on ESP32 end.</em></p>
<p>Setting up the sensor in ESPHome is really easy:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">sensor:
  - <span style="color:#66d9ef">platform</span>: hx711
    <span style="color:#66d9ef">name</span>: <span style="color:#e6db74">&#34;Bed Weight (L)&#34;</span>
    <span style="color:#66d9ef">id</span>: bed_weight_l
    <span style="color:#66d9ef">dout_pin</span>: <span style="color:#ae81ff">12</span>
    <span style="color:#66d9ef">clk_pin</span>: <span style="color:#ae81ff">14</span>
</code></pre></div><p>We&rsquo;ll be calibrating and adding filtering to this sensor next.</p>
<h3 id="calibrating-the-hx711-sensors">Calibrating the HX711 sensors</h3>
<p>Out of the box the numbers spat out by the HX711 means nothing much. In order to calibrate you start by taking note of the values when there is no-load (or just the expected normal load &ndash; the mattress and bed sheets in this case) and you will need to do the same with at least one known-weight load (thus more is better) on top of your scale and take note of the numbers shown, average them and use in the <code>calibrate_linear</code> filter on ESPHome.</p>
<p>I had my full clothes hamper at hand so I weighted myself holding it in a regular bathroom scale, then weighted myself alone and subtracted both weights to get the weight of the clothes hamper (5.6kg &ndash; I know, not <em>freedom units</em>), then used it as a known-weight to calibrate my bed sensor. I also used my faithful <code>sliding_window_moving_average</code> filter to iron out erroneous readings and help <em>false-negatives</em> while changing sleep positions at night.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">filters:
  - calibrate_linear:
      - <span style="color:#ae81ff">66000</span> -&gt; <span style="color:#ae81ff">0</span>
      - <span style="color:#ae81ff">145000</span> -&gt; <span style="color:#ae81ff">5.6</span>
  - sliding_window_moving_average:
      <span style="color:#66d9ef">window_size</span>: <span style="color:#ae81ff">5</span>
      <span style="color:#66d9ef">send_every</span>: <span style="color:#ae81ff">5</span>
</code></pre></div><h3 id="watch-out-about-wifi-powersave">Watch out about WiFi powersave</h3>
<p>On ESPHome, the default setting for <code>power_save_mode</code> under <code>wifi</code> for ESP32s is <code>LIGHT</code> and that will make your sensor go <code>unavailable</code> from time to time due the ESP32 disconnecting from WiFi in order to save power. Make sure to change it to <code>none</code> to have it available all the time (we&rsquo;re running constant power through USB so no worries there).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">wifi:
  <span style="color:#66d9ef">ssid</span>: <span style="color:#e6db74">&#34;Your Wifi SSID&#34;</span>
  <span style="color:#66d9ef">password</span>: !secret wifi_password
  <span style="color:#66d9ef">power_save_mode</span>: none
</code></pre></div><p>Full code</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">esphome:
  <span style="color:#66d9ef">name</span>: meistersensor_bedsensor
  <span style="color:#66d9ef">platform</span>: ESP32
  <span style="color:#66d9ef">board</span>: nodemcu-32s

wifi:
  <span style="color:#66d9ef">ssid</span>: <span style="color:#e6db74">&#34;Your Wifi SSID&#34;</span>
  <span style="color:#66d9ef">password</span>: !secret wifi_password
  <span style="color:#66d9ef">power_save_mode</span>: none

<span style="color:#75715e"># Enable logging</span>
logger:

<span style="color:#75715e"># Enable Home Assistant API</span>
api:
  <span style="color:#66d9ef">password</span>: !secret api_ota_password

ota:
  <span style="color:#66d9ef">password</span>: !secret api_ota_password

sensor:
  - <span style="color:#66d9ef">platform</span>: hx711
    <span style="color:#66d9ef">name</span>: <span style="color:#e6db74">&#34;Bed Weight (L)&#34;</span>
    <span style="color:#66d9ef">id</span>: bed_weight_l
    <span style="color:#66d9ef">dout_pin</span>: <span style="color:#ae81ff">12</span>
    <span style="color:#66d9ef">clk_pin</span>: <span style="color:#ae81ff">14</span>
    filters:
      - calibrate_linear:
          - <span style="color:#ae81ff">66000</span> -&gt; <span style="color:#ae81ff">0</span>
          - <span style="color:#ae81ff">145000</span> -&gt; <span style="color:#ae81ff">5.6</span>
      - sliding_window_moving_average:
          <span style="color:#66d9ef">window_size</span>: <span style="color:#ae81ff">5</span>
          <span style="color:#66d9ef">send_every</span>: <span style="color:#ae81ff">5</span>
    <span style="color:#66d9ef">update_interval</span>: 2s
    <span style="color:#66d9ef">unit_of_measurement</span>: kg
    <span style="color:#66d9ef">accuracy_decimals</span>: <span style="color:#ae81ff">2</span>
      
  - <span style="color:#66d9ef">platform</span>: hx711
    <span style="color:#66d9ef">name</span>: <span style="color:#e6db74">&#34;Bed Weight (R)&#34;</span>
    <span style="color:#66d9ef">id</span>: bed_weight_r
    <span style="color:#66d9ef">dout_pin</span>: <span style="color:#ae81ff">19</span>
    <span style="color:#66d9ef">clk_pin</span>: <span style="color:#ae81ff">18</span>
    filters:
      - calibrate_linear:
          - <span style="color:#ae81ff">435000</span> -&gt; <span style="color:#ae81ff">0</span>
          - <span style="color:#ae81ff">512000</span> -&gt; <span style="color:#ae81ff">5.6</span>
      - sliding_window_moving_average:
          <span style="color:#66d9ef">window_size</span>: <span style="color:#ae81ff">5</span>
          <span style="color:#66d9ef">send_every</span>: <span style="color:#ae81ff">5</span>
    <span style="color:#66d9ef">update_interval</span>: 2s
    <span style="color:#66d9ef">unit_of_measurement</span>: kg
    <span style="color:#66d9ef">accuracy_decimals</span>: <span style="color:#ae81ff">2</span>
    
binary_sensor:
  - <span style="color:#66d9ef">platform</span>: template
    <span style="color:#66d9ef">name</span>: <span style="color:#e6db74">&#34;Bed Occupancy (Left)&#34;</span>
    <span style="color:#66d9ef">device_class</span>: occupancy
    <span style="color:#66d9ef">lambda</span>: |<span style="color:#e6db74">-
</span><span style="color:#e6db74">      if (id(bed_weight_l).state &gt; 10) {</span>
        return <span style="color:#66d9ef">true</span>;
      } else {
        return <span style="color:#66d9ef">false</span>;
      }
  - <span style="color:#66d9ef">platform</span>: template
    <span style="color:#66d9ef">name</span>: <span style="color:#e6db74">&#34;Bed Occupancy (Right)&#34;</span>
    <span style="color:#66d9ef">device_class</span>: occupancy
    <span style="color:#66d9ef">lambda</span>: |<span style="color:#e6db74">-
</span><span style="color:#e6db74">      if (id(bed_weight_r).state &gt; 10) {</span>
        return <span style="color:#66d9ef">true</span>;
      } else {
        return <span style="color:#66d9ef">false</span>;
      }
</code></pre></div><h3 id="creating-groups-for-the-bed-occupancy">Creating groups for the bed occupancy</h3>
<p>Groups are useful for a bunch of stuff. We&rsquo;ll use in our sensor to create two more <em>pseudo sensors</em> to indicate wether the bed is occupied and/or full.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">group:
  bed_occupied:
    <span style="color:#66d9ef">name</span>: <span style="color:#e6db74">&#34;Bed Occupied&#34;</span>
    entities:
      - binary_sensor.bed_occupancy_left
      - binary_sensor.bed_occupancy_right
  bed_full:
    <span style="color:#66d9ef">name</span>: <span style="color:#e6db74">&#34;Bed Full&#34;</span>
    entities:
      - binary_sensor.bed_occupancy_left
      - binary_sensor.bed_occupancy_right
    <span style="color:#66d9ef">all</span>: <span style="color:#66d9ef">true</span>
</code></pre></div><p>I usually also pair them with a <code>Template binary_sensor</code> to make them prettier:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">binary_sensor:
  - <span style="color:#66d9ef">platform</span>: template
    sensors:
      <span style="color:#75715e"># Bed Sensors</span>
      bed_occupied:
        <span style="color:#66d9ef">friendly_name</span>: Bed Occupied (Master Bedroom)
        <span style="color:#66d9ef">device_class</span>: occupancy
        <span style="color:#66d9ef">value_template</span>: &gt;<span style="color:#e6db74">-
</span><span style="color:#e6db74">          {{ is_state(&#39;group.bed_occupied&#39;, &#39;on&#39;) }}</span>
      bed_full:
        <span style="color:#66d9ef">friendly_name</span>: Bed Full (Master Bedroom)
        <span style="color:#66d9ef">device_class</span>: occupancy
        <span style="color:#66d9ef">value_template</span>: &gt;<span style="color:#e6db74">-
</span><span style="color:#e6db74">          {{ is_state(&#39;group.bed_full&#39;, &#39;on&#39;) }}</span>
</code></pre></div><h3 id="automate-your-bed">Automate your bed</h3>
<p>Now that you can <em>sense</em> occupancy on you bed, you can go crazy with the automations. See below a curated list of my bed automations.</p>
<ul>
<li>Turn off all lights when <code>bed_full</code></li>
<li>Turn on the alarm at night when <code>bed_full</code></li>
<li>Turn off the alarm in the morning when not <code>bed_full</code></li>
<li>Turn on the lightstrips under the bed when (movement in front of the nightstand) when not <code>bed_occupied</code> (night lights)</li>
<li>Disable Alexa voice notifications (<code>input_boolean.voice_notifications</code>) when <code>bed_occupied</code></li>
</ul>
<p>That&rsquo;s all for today folks! If you have any questions or comments, please leave below!</p>
        </div>
      </div>
      <div class="col-lg-12 mx-auto block shadow mb-5">
        
        
        
        <h3>You might also be interested in:</h3>
        <ul>
          
          <li><a href="/posts/multisensors-with-esphome-on-homeassistant/">Building custom multisensors with an ESP8266 and ESPHome on Home Assistant</a></li>
          
          <li><a href="/posts/using-alexa-to-greet-you-with-home-assistant/">Using Alexa to greet you with Home Assistant</a></li>
          
        </ul>
        
      </div>
      
      <div class="col-lg-12 mx-auto block shadow">
        
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "synapse-labs" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
      
    </div>
  </div>
</section>


<footer class="py-4 bg-light border-top">
  <div class="container">
    <div class="row justify-content-between align-items-center">
      <div class="col-lg-4 text-center text-lg-left mb-4 mb-lg-0">
        <a href="https://synapselabs.io/" class="d-block pb-3"><img src="/images/logo.png" class="img-fluid" alt="synapse labs ðŸ§ "></a>
      </div>
      <div class="col-lg-4 text-center mb-4 mb-lg-0">
        <ul class="list-inline mb-0">
          
          <li class="list-inline-item"><a class="text-dark d-block p-2" href="https://synapselabs.io/about">About</a></li>
          
          <li class="list-inline-item"><a class="text-dark d-block p-2" href="https://synapselabs.io/contact">Contact</a></li>
          
        </ul>
      </div>
      <div class="col-lg-4 text-lg-right text-center mb-4 mb-lg-0">
        <ul class="list-inline social-icon mb-0">
          
          <li class="list-inline-item"><a href="https://twitter.com/jseidl"><i class="ti-twitter-alt"></i></a></li>
          
          <li class="list-inline-item"><a href="https://github.com/jseidl"><i class="ti-github"></i></a></li>
          
          <li class="list-inline-item"><a href="https://www.linkedin.com/in/janseidl"><i class="ti-linkedin"></i></a></li>
          
        </ul>
      </div>
    </div>
    <div class="text-center mt-4">
      <span>Â© 2020 <a href="https://synapselabs.io">synapse labs</a> All Rights Reserved</span>
    </div>
  </div>
</footer>




<script>
  var indexURL = "https://synapselabs.io/index.json"
</script>


<!-- JS Plugins -->

<script src="https://synapselabs.io/plugins/jQuery/jquery.min.js"></script>

<script src="https://synapselabs.io/plugins/bootstrap/bootstrap.min.js"></script>

<script src="https://synapselabs.io/plugins/search/fuse.min.js"></script>

<script src="https://synapselabs.io/plugins/search/mark.js"></script>

<script src="https://synapselabs.io/plugins/search/search.js"></script>


<!-- Main Script -->

<script src="https://synapselabs.io/js/script.min.js"></script>


<!-- google analitycs -->
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-163621923-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</body>

</html>